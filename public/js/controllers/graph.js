// Generated by CoffeeScript 1.6.2
(function() {
  define(['jquery', 'underscore', 'moment', 'dbLogic'], function($, _, moment, dbLogic) {
    return [
      '$scope', '$rootScope', '$location', '$routeParams', '$timeout', 'dbService', function($scope, $rootScope, $location, $routeParams, $timeout, dbService) {
        var getSelectedFieldIndex, updateFields;

        $scope._id = $routeParams['_id'];
        if ($routeParams['_id'] != null) {
          dbService.cacheGet($routeParams['_id'], function(data) {
            dbService.dataSet = data;
            $scope.dataSet = dbService.dataSet;
            return $rootScope.$broadcast('dataSetLoaded');
          });
        } else {
          $scope.dataSet = dbService.dataSet;
          $rootScope.$broadcast('dataSetLoaded');
        }
        $scope.removeDbReference = function(idx) {
          $scope.dataSet.dbReferences.splice(idx(1));
          dbService.dataSet = $scope.dataSet;
          return dbService.cacheUpsert(function() {
            return $rootScope.$broadcast('dataSetLoaded');
          });
        };
        $scope.optionsSetOnField = function(field) {
          var _ref, _ref1, _ref2, _ref3;

          if ((field.groupBy != null) && ((_ref = field.groupBy) !== (void 0) && _ref !== '')) {
            return true;
          }
          if ((field.aggregation != null) && ((_ref1 = field.aggregation) !== (void 0) && _ref1 !== '')) {
            return true;
          }
          if ((field.beginDate != null) && ((_ref2 = field.beginDate) !== (void 0) && _ref2 !== '')) {
            return true;
          }
          if ((field.endDate != null) && ((_ref3 = field.endDate) !== (void 0) && _ref3 !== '')) {
            return true;
          }
          return false;
        };
        getSelectedFieldIndex = function() {
          var fieldIndex;

          fieldIndex = _.findIndex($scope.dataSet.dbReferences[$scope.dbRefIndex].fields, function(item) {
            if (item['COLUMN_NAME'] != null) {
              return item['COLUMN_NAME'] === $scope.selectedFieldName;
            } else {
              return item === $scope.selectedFieldName;
            }
          });
          return fieldIndex;
        };
        updateFields = function(variableNames) {
          var fieldIndex;

          fieldIndex = getSelectedFieldIndex();
          return _.each(variableNames, function(variableName) {
            return $scope.dataSet.dbReferences[$scope.dbRefIndex].fields[fieldIndex][variableName] = $scope[variableName];
          });
        };
        $scope.$on('dataSetLoaded', function() {
          return dbService.queryDataSet(function(data) {
            return dbLogic.processDataSet($scope.dataSet, data, function(err, d3Data) {
              return $scope.d3DataSet = d3Data;
            });
          });
        });
        $scope.$on('dataSetFieldChange', function() {
          return dbLogic.processDataSet($scope.dataSet);
        });
        $scope.$on('dataSetFieldChange', function() {
          return dbLogic.processDataSet($scope.dataSet);
        });
        $scope.aggregation = void 0;
        $scope.aggregationOptions = [
          {
            name: 'aggregation',
            value: void 0,
            label: 'No Selection'
          }, {
            name: 'aggregation',
            value: 'count',
            label: 'Count'
          }, {
            name: 'aggregation',
            value: 'distinctCount',
            label: 'Distinct Count'
          }, {
            name: 'aggregation',
            value: 'sum',
            label: 'Sum'
          }, {
            name: 'aggregation',
            value: 'avg',
            label: 'Avg'
          }
        ];
        $scope.groupBy = void 0;
        $scope.groupByOptions = [
          {
            name: 'groupFieldBy',
            value: void 0,
            label: 'No Selection'
          }, {
            name: 'groupFieldBy',
            value: 'field',
            label: 'Field Itself'
          }, {
            name: 'groupFieldBy',
            value: 'year',
            label: 'Year'
          }, {
            name: 'groupFieldBy',
            value: 'month',
            label: 'Month'
          }, {
            name: 'groupFieldBy',
            value: 'day',
            label: 'Day'
          }, {
            name: 'groupFieldBy',
            value: 'hour',
            label: 'Hour'
          }
        ];
        $scope.selectedReference = void 0;
        $scope.selectedField = void 0;
        $scope.selectedFieldName = void 0;
        $scope.openModalForField = function(dbRefIndex, r, f) {
          $scope.dbRefIndex = dbRefIndex;
          $scope.selectedReference = r;
          $scope.selectedField = f;
          $scope.selectedFieldName = f['COLUMN_NAME'] != null ? f['COLUMN_NAME'] : f;
          $scope.aggregation = f['aggregation'];
          $scope.groupBy = f['groupBy'];
          $scope.beginDate = f['beginDate'];
          $scope.endDate = f['endDate'];
          return $('#graph_field_modal').modal();
        };
        $scope.openModalForOptions = function() {
          return $('#graph_options_modal').modal();
        };
        $scope.updateDataSet = function(graph) {
          var variablesToUpdate;

          if (graph == null) {
            graph = true;
          }
          variablesToUpdate = ['aggregation', 'groupBy', 'beginDate', 'endDate'];
          updateFields(variablesToUpdate);
          dbService.dataSet = $scope.dataSet;
          return dbService.cacheUpsert(function() {
            if (graph) {
              return $rootScope.$broadcast('dataSetLoaded');
            }
          });
        };
        $scope.deleteDataSet = function() {
          $('#graph_options_modal').modal('hide');
          return $timeout((function() {
            return dbService.cacheDelete($scope.dataSet._id, function() {
              return $location.path("/AddData/");
            });
          }), 1000);
        };
        $scope.updateMetaData = function() {
          console.log("Updating graph options with graph name: " + $scope.dataSet.name);
          dbService.dataSet = $scope.dataSet;
          return dbService.cacheUpsert(function() {
            console.log("dataSet upserted, setting the scope to dbService.dataSet");
            return $rootScope.$broadcast('dataSetLoaded');
          });
        };
        $scope.beginDate = void 0;
        $scope.endDate = void 0;
        $scope.beginDateOpened = false;
        $scope.endDateOpened = false;
        $scope.dateOptions = {
          'year-format': "'yyyy'",
          'starting-day': 1
        };
        $scope.today = function() {
          return $scope.dt = new Date();
        };
        $scope.clearBeginDate = function() {
          return $scope.beginDate = void 0;
        };
        $scope.clearEndDate = function() {
          return $scope.endDate = void 0;
        };
        $scope.openBeginDate = function() {
          return $timeout(function() {
            return $scope.beginDateOpened = true;
          });
        };
        $scope.openEndDate = function() {
          return $timeout(function() {
            return $scope.endDateOpened = true;
          });
        };
        $scope.testGraph = function() {
          dbService.queryDb($scope.connection, $scope.schema, $scope.table, $scope.fields, function(data) {
            return console.log(data);
          });
          return console.log("Test graph " + (JSON.stringify($scope.fields)));
        };
        return $scope.$apply();
      }
    ];
  });

}).call(this);

/*
//@ sourceMappingURL=graph.map
*/
