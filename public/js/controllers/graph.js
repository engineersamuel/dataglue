// Generated by CoffeeScript 1.6.2
(function() {
  define(['jquery', 'underscore'], function($, _) {
    return [
      '$scope', '$location', '$routeParams', '$timeout', 'dbService', function($scope, $location, $routeParams, $timeout, dbService) {
        var getSelectedFieldIndex;

        $scope._id = $routeParams['_id'];
        if ($routeParams['_id'] != null) {
          dbService.cacheGet($routeParams['_id'], function(data) {
            dbService.dataSet = data;
            return $scope.dataSet = dbService.dataSet;
          });
        } else {
          $scope.dataSet = dbService.dataSet;
        }
        getSelectedFieldIndex = function() {
          var fieldIndex;

          fieldIndex = _.findIndex(dbService.dataSet.dbReferences[$scope.selectedReference.key].fields, function(item) {
            if (item['COLUMN_NAME'] != null) {
              return item['COLUMN_NAME'] === $scope.selectedFieldName;
            } else {
              return item === $scope.selectedFieldName;
            }
          });
          return fieldIndex;
        };
        $scope.updateField = function(variableNames) {
          var fieldIndex;

          fieldIndex = getSelectedFieldIndex();
          _.each(variableNames, function(variableName) {
            return dbService.dataSet.dbReferences[$scope.selectedReference.key].fields[fieldIndex][variableName] = $scope[variableName];
          });
          return $scope.dataSet = dbService.dataSet;
        };
        $scope.d3DataSet = [];
        $scope.$watch('dataSet', function() {
          var dbData;

          return dbData = dbService.queryDataSet(function(data) {
            return console.log("dataSet: " + (JSON.stringify(data)));
          });
        });
        $scope.aggregation = void 0;
        $scope.aggregationOptions = [
          {
            name: 'aggregation',
            value: void 0,
            label: 'No Selection'
          }, {
            name: 'aggregation',
            value: 'count',
            label: 'Count'
          }, {
            name: 'aggregation',
            value: 'distinctCount',
            label: 'Distinct Count'
          }, {
            name: 'aggregation',
            value: 'sum',
            label: 'Sum'
          }, {
            name: 'aggregation',
            value: 'avg',
            label: 'Avg'
          }, {
            name: 'aggregation',
            value: 'median',
            label: 'Median'
          }
        ];
        $scope.groupBy = void 0;
        $scope.groupByOptions = [
          {
            name: 'groupFieldBy',
            value: void 0,
            label: 'No Selection'
          }, {
            name: 'groupFieldBy',
            value: 'field',
            label: 'Field itself'
          }, {
            name: 'groupFieldBy',
            value: 'year',
            label: 'Year'
          }, {
            name: 'groupFieldBy',
            value: 'quarter',
            label: 'Quarter'
          }, {
            name: 'groupFieldBy',
            value: 'month',
            label: 'Month'
          }, {
            name: 'groupFieldBy',
            value: 'day',
            label: 'Day'
          }
        ];
        $scope.selectedReference = void 0;
        $scope.selectedField = void 0;
        $scope.selectedFieldName = void 0;
        $scope.openModalForField = function(r, f) {
          $scope.selectedReference = r;
          $scope.selectedField = f;
          $scope.selectedFieldName = f['COLUMN_NAME'] != null ? f['COLUMN_NAME'] : f;
          $scope.aggregation = f['aggregation'];
          $scope.groupBy = f['groupBy'];
          $scope.beginDate = f['beginDate'];
          $scope.endDate = f['endDate'];
          return $('#graph_field_modal').modal();
        };
        $scope.updateDataSet = function() {
          var variablesToUpdate;

          variablesToUpdate = ['aggregation', 'groupBy', 'beginDate', 'endDate'];
          $scope.updateField(variablesToUpdate);
          return dbService.cacheUpsert(function() {
            return void 0;
          });
        };
        $scope.beginDate = void 0;
        $scope.endDate = void 0;
        $scope.beginDateOpened = false;
        $scope.endDateOpened = false;
        $scope.dateOptions = {
          'year-format': "'yyyy'",
          'starting-day': 1
        };
        $scope.today = function() {
          return $scope.dt = new Date();
        };
        $scope.clearBeginDate = function() {
          return $scope.beginDate = void 0;
        };
        $scope.clearEndDate = function() {
          return $scope.endDate = void 0;
        };
        $scope.openBeginDate = function() {
          return $timeout(function() {
            return $scope.beginDateOpened = true;
          });
        };
        $scope.openEndDate = function() {
          return $timeout(function() {
            return $scope.endDateOpened = true;
          });
        };
        $scope.testGraph = function() {
          dbService.queryDb($scope.connection, $scope.schema, $scope.table, $scope.fields, function(data) {
            return console.log(data);
          });
          return console.log("Test graph " + (JSON.stringify($scope.fields)));
        };
        return $scope.$apply();
      }
    ];
  });

}).call(this);

/*
//@ sourceMappingURL=graph.map
*/
