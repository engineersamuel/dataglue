// Generated by CoffeeScript 1.6.2
(function() {
  define(["angular", "services", "d3", "nv", "moment", "bubble"], function(angular, services, d3, nv, moment, Bubble) {
    "use strict";    return angular.module("dataGlue.directives", ["dataGlue.services"]).directive("appVersion", [
      "version", function(version) {
        return function(scope, elm, attrs) {
          return elm.text(version);
        };
      }
    ]).directive("dirTableVis", function() {
      return {
        restrict: "E",
        scope: {
          val: "=",
          grouped: "="
        },
        link: function(scope, element, attrs) {
          var tables;

          tables = function(data) {
            var divs, vis;

            console.log("tables:data: " + (JSON.stringify(data)));
            vis = d3.select(element[0]);
            divs = vis.selectAll("div").data(data, function(d) {
              return d['TABLE_NAME'];
            });
            divs.enter().append('div').attr('class', 'db-info-item').text(function(d) {
              return d['TABLE_NAME'];
            });
            divs.exit().transition().duration(300).ease("exp").style("opacity", 0).remove();
            return divs.attr("opacity", 1).transition().duration(500).ease("exp");
          };
          return scope.$watch('val', function(newVal, oldVal) {
            if (newVal === void 0) {
              return;
            }
            return tables(newVal);
          });
        }
      };
    }).directive("d3Visualization", function() {
      return {
        restrict: "E",
        scope: {
          val: "=",
          type: "="
        },
        link: function(scope, element, attrs) {
          var bubbleGraph, chart, data, graphType, handleBubble, handleChart, handleOptionsChanges, setAxisFormatting;

          data = void 0;
          graphType = void 0;
          chart = void 0;
          bubbleGraph = void 0;
          setAxisFormatting = function(dataSet, chart) {
            var xAxisDataType, xAxisGroupBy, yAxisDataType, _ref, _ref1, _ref2, _ref3, _ref4, _ref5;

            xAxisDataType = (_ref = dataSet[0]) != null ? (_ref1 = _ref[0]) != null ? _ref1.xType : void 0 : void 0;
            xAxisGroupBy = (_ref2 = dataSet[0]) != null ? (_ref3 = _ref2[0]) != null ? _ref3.xGroupBy : void 0 : void 0;
            yAxisDataType = (_ref4 = dataSet[0]) != null ? (_ref5 = _ref4[0]) != null ? _ref5.yType : void 0 : void 0;
            if (yAxisDataType === 'int') {
              chart.yAxis.tickFormat(function(d) {
                return d3.format("d")(d);
              });
            } else if (yAxisDataType === 'float') {
              chart.yAxis.tickFormat(d3.format(',.1f'));
            }
            if (xAxisDataType === 'datatime') {
              if ((xAxisGroupBy != null) === 'day') {
                chart.xAxis.tickFormat(function(d) {
                  return moment(d).format('YYYY-MM-DD');
                });
              } else if ((xAxisGroupBy != null) === 'month') {
                chart.xAxis.tickFormat(function(d) {
                  return moment(d).format('YYYY-MM');
                });
              } else {
                chart.xAxis.tickFormat(function(d) {
                  return moment(d).format('YYYY-MM-DD');
                });
              }
            }
            return chart.yAxis.tickFormat(function(d) {
              return d3.format("d")(d);
            });
          };
          handleChart = function(dataSet) {
            if (chart == null) {
              console.log("Creating a new d3 Graph");
              return nv.addGraph(function() {
                chart = nv.models.multiBarChart().margin({
                  top: 10,
                  right: 30,
                  bottom: 150,
                  left: 30
                }).x(function(d) {
                  return d.x;
                }).y(function(d) {
                  return d.y;
                }).tooltip(function(key, x, y, e, graph) {
                  return "<h3>" + key + "</h3><p>" + y + " on " + x + "</p>";
                });
                setAxisFormatting(dataSet, chart);
                data = dataSet == null ? exampleData() : dataSet;
                console.log("data: " + data);
                d3.select("#graph_container svg").datum(data).transition().duration(500).call(chart);
                nv.utils.windowResize(chart.update);
                return chart;
              });
            } else {
              console.log("Updating the d3 graph with: " + (JSON.stringify(dataSet)));
              setAxisFormatting(dataSet, chart);
              d3.select("#graph_container svg").datum(dataSet).transition().duration(500).call(chart);
              return chart.update();
            }
          };
          handleBubble = function() {
            bubbleGraph = new Bubble();
            bubbleGraph.initialize_data(data);
            bubbleGraph.start();
            return bubbleGraph.display_group_all();
          };
          handleOptionsChanges = function() {
            if (data != null) {
              if (graphType === 'multiBarChart') {
                return handleChart();
              } else if (graphType === 'bubble') {
                return handleBubble();
              } else {
                return console.warn("Data to graph but no type of Graph selected!");
              }
            } else {
              return console.warn("No data given to graph!");
            }
          };
          scope.$watch("val", function(newVal, oldVal) {
            console.log("$watch val: " + (JSON.stringify(newVal)));
            data = newVal;
            return handleOptionsChanges();
          });
          return scope.$watch("type", function(newVal, oldVal) {
            console.log("$watch type: " + newVal);
            graphType = newVal;
            return handleOptionsChanges();
          });
        }
      };
    });
  });

}).call(this);

/*
//@ sourceMappingURL=directives.map
*/
