// Generated by CoffeeScript 1.6.2
(function() {
  var Db, DbQuery, async, logger, mongodb, mysql, prettyjson, settings, utils, _;

  settings = require('../utilitis/settings');

  utils = require('../utilitis/utils');

  mysql = require('mysql');

  _ = require('lodash');

  logger = require('tracer').colorConsole(utils.logger_config);

  mongodb = require('mongodb');

  Db = require('mongodb').Db;

  prettyjson = require('prettyjson');

  async = require('async');

  DbQuery = {};

  DbQuery.query = function(dbReference, queryHash, callback) {
    var self;

    self = this;
    logger.debug("Query: " + (JSON.stringify(queryHash.query)));
    if (dbReference.type === 'mysql') {
      logger.debug("Querying mysql reference: " + dbReference.name + " with queryHash: " + (prettyjson.render(queryHash)));
      DbQuery.mysqlQuery(dbReference, queryHash, function(err, results) {
        if (err) {
          return callback(err);
        } else {
          return callback(null, results);
        }
      });
    } else if (dbReference.type === 'mongo') {
      DbQuery.mongoQuery(dbReference, queryHash, function(err, results) {
        return callback(err, results);
      });
    }
    return self;
  };

  DbQuery.mongoQuery = function(dbReference, queryHash, callback) {
    var dbRefCopy, mongoUrl, self;

    self = this;
    dbRefCopy = _.assign(dbReference, settings.db_refs[dbReference.connection || dbReference.name]);
    if (queryHash.command != null) {
      dbRefCopy.db = 'admin';
    } else {
      dbRefCopy.db = dbReference.schema;
    }
    mongoUrl = utils.generateMongoUrl(dbRefCopy);
    Db.connect(mongoUrl, function(err, db) {
      if (queryHash.command != null) {
        return async.waterfall([
          function(callback) {
            return db.command(queryHash.command, function(err, results) {
              callback(err, results);
              return db.close();
            });
          }
        ], function(err, results) {
          return callback(err, results);
        });
      } else {
        return async.waterfall([
          function(callback) {
            return db.collection(dbRefCopy.table, function(err, coll) {
              return callback(err, coll);
            });
          }, function(coll, callback) {
            return coll.aggregate(queryHash.query, function(err, result) {
              return callback(err, result);
            });
          }
        ], function(err, result) {
          return callback(err, result);
        });
      }
    });
    return self;
  };

  DbQuery.showCollections = function(dbReference, dbName, callback) {
    var dbRefCopy, mongoUrl, self;

    self = this;
    dbRefCopy = _.assign(dbReference, settings.db_refs[dbReference.connection || dbReference.name]);
    dbRefCopy.db = dbName;
    mongoUrl = utils.generateMongoUrl(dbRefCopy);
    Db.connect(mongoUrl, function(err, db) {
      if (err) {
        return logger.error(err);
      } else {
        return db.collectionNames(function(err, collectionNames) {
          callback(err, _.map(collectionNames, function(item) {
            return {
              TABLE_NAME: item.name.replace(dbName + '.', '')
            };
          }));
          return db.close();
        });
      }
    });
    return self;
  };

  DbQuery.showFields = function(dbReference, dbName, collectionName, callback) {
    var dbRefCopy, mongoUrl, self;

    self = this;
    dbRefCopy = _.assign(dbReference, settings.db_refs[dbReference.connection || dbReference.name]);
    dbRefCopy.db = dbName;
    mongoUrl = utils.generateMongoUrl(dbRefCopy);
    Db.connect(mongoUrl, function(err, db) {
      if (err) {
        return callback(err);
      } else {
        return db.collection(collectionName, function(err, coll) {
          if (err) {
            return callback(err);
          } else {
            return coll.findOne({}, function(err, doc) {
              callback(null, _.map(_.keys(doc), function(f) {
                return {
                  COLUMN_NAME: f,
                  DATA_TYPE: utils.setMongoFieldDataType(doc[f]),
                  COLUMN_TYPE: void 0,
                  COLUMN_KEY: void 0
                };
              }));
              return db.close();
            });
          }
        });
      }
    });
    return self;
  };

  DbQuery.mysqlQuery = function(dbReference, queryHash, callback) {
    var conn, mysql_ref, self;

    self = this;
    mysql_ref = settings.mysql_refs[dbReference.connection || dbReference.name];
    conn = mysql.createConnection({
      host: mysql_ref['host'],
      user: mysql_ref['user'],
      password: mysql_ref['pass']
    });
    logger.debug("Querying mysql reference: " + dbReference.connection + " with query: " + (prettyjson.render(queryHash.query)));
    conn.query(queryHash.query, function(err, results) {
      if (err) {
        logger.debug("Error Querying mysql reference: " + dbReference.connection + " with sql: " + queryHash + ", err: " + (prettyjson.render(err)));
        callback(err);
      } else {
        logger.debug("Found " + results.length + " results.");
        callback(null, results);
      }
      return conn.end();
    });
    return self;
  };

  module.exports = DbQuery;

}).call(this);

/*
//@ sourceMappingURL=dbQuery.map
*/
